apiVersion: kuttl.dev/v1beta1
kind: TestAssert
timeout: 240
commands:
  - script: |-
      kubectl get pg-restore -n "${NAMESPACE}" && sleep 5
      kubectl get pods -n "${NAMESPACE}"
      kubectl get pg -o yaml -n "${NAMESPACE}"
collectors:
  - type: pod
    selector: "app.kubernetes.io/component=operator"
---
apiVersion: pgv2.percona.com/v2
kind: PerconaPGCluster
metadata:
  finalizers:
    - percona.com/stop-watchers
  generation: 10
spec:
  backups:
    pgbackrest:
      configuration:
      - secret:
          name: demand-backup-pgbackrest-secrets
      global:
        repo1-retention-full: "2"
        repo1-retention-full-type: count
        repo3-retention-full: "2"
        repo3-retention-full-type: count
      manual:
        options:
          - --type=full
          - --annotation="percona.com/backup-name"="demand-backup-full-azure"
        repoName: repo3
      repos:
      - name: repo1
        s3:
          bucket: pg-operator-testing
          endpoint: s3.amazonaws.com
          region: us-east-1
      - name: repo3
        azure:
          container: pg-operator-testing
  proxy:
    pgBouncer:
      replicas: 3
  users:
    - name: postgres
      password:
        type: AlphaNumeric
    - name: demand-backup
      password:
        type: AlphaNumeric
status:
  pgbouncer:
    ready: 3
    size: 3
  postgres:
    instances:
    - name: instance1
      ready: 3
      size: 3
    ready: 3
    size: 3
  state: ready
---
apiVersion: pgv2.percona.com/v2
kind: PerconaPGRestore
metadata:
  name: demand-backup-restore
spec:
  pgCluster: demand-backup
  repoName: repo1
status:
  state: Succeeded
